<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat</title>
		<link rel = "stylesheet" href="./style.css">
		<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

	</head>
	<body>
		<h1 style="text-align: center" class="logo">CHAT ROOM</h1>

		<div id="status" class="status"><i class='bx bx-station'></i></div>

		<div id="messages" class="chat-area"></div>

		<div class="input-container">
			<input
				type="text"
				id="messageInput"
				placeholder="Type your message..."
				autocomplete="off"
				disabled
			/>
			<button id="sendButton" disabled>Send</button>
		</div>

		<script>
			const messagesContainer = document.getElementById('messages');
			const messageInput = document.getElementById('messageInput');
			const sendButton = document.getElementById('sendButton');
			const statusDiv = document.getElementById('status');
			let myId = null;

			let socket = null;
			let reconnectAttempts = 0;
			const maxReconnectAttempts = 5;

			function connectWebSocket() {
				try {
					const protocol =
						window.location.protocol === 'https:' ? 'wss:' : 'ws:';
					const wsHost =
						window.location.hostname === '127.0.0.1'
							? 'localhost:3000'
							: window.location.host;
					socket = new WebSocket(`${protocol}//${wsHost}/ws`);

					setupSocketEvents();
				} catch (error) {
					console.error('Failed to create WebSocket:', error);
					handleDisconnection();
				}
			}

			function setupSocketEvents() {
				socket.onopen = function () {
					console.log('WebSocket connected');
					statusDiv.className = "status connected"
					messageInput.disabled = false;
					sendButton.disabled = false;
					reconnectAttempts = 0;
					addMessage('Connected to chat server', 'system');
					messageInput.focus();
				};

				socket.onmessage = function (event) {
					try {
						const data = JSON.parse(event.data);
						
						addMessage(data.data, data.type, data.timestamp, data.userId);
					} catch (e) {
						addMessage(event.data, 'message');
					}
				};

				socket.onerror = function (error) {
					console.error('WebSocket error:', error);
					statusDiv.className = "status error"
				};

				socket.onclose = function (event) {
					console.log('WebSocket closed:', event.code, event.reason);
					handleDisconnection();
				};
			}

			function handleDisconnection() {
				statusDiv.className = "status reconnect"
				messageInput.disabled = true;
				sendButton.disabled = true;

				addMessage('Disconnected from server', 'system');

				if (reconnectAttempts < maxReconnectAttempts) {
					reconnectAttempts++;
					setTimeout(() => {
						connectWebSocket();
					}, 2000 * reconnectAttempts); // Exponential backoff
				} else {
					statusDiv.className = "status error"
					addMessage('Failed to reconnect to server', 'error');
				}
			}

			// Отправка сообщения
			function sendMessage() {
				const message = messageInput.value.trim();
				if (message && socket && socket.readyState === WebSocket.OPEN) {
					socket.send(message);
					messageInput.value = '';
				}
			}

			// Добавление сообщения в чат
			function addMessage(
				text,
				type = 'message',
				timestamp = new Date().toLocaleTimeString(),
				userId
			) {
				if (userId && !myId){
					myId = userId
					
				}
				console.log(userId, myId, userId== myId)
				const messageDiv = document.createElement('div');
				messageDiv.className = `message ${type} ${userId == myId ? "from" : "to"}`;
				

				const messageText = document.createElement('div');
				messageText.className = 'messageText'
				messageText.textContent = text;

				const timeSpan = document.createElement('div');
				timeSpan.className = 'timestamp';
				timeSpan.textContent = timestamp;

				messageDiv.appendChild(messageText);
				messageDiv.appendChild(timeSpan);

				messagesContainer.appendChild(messageDiv);
				messagesContainer.scrollTop = messagesContainer.scrollHeight;
			}

			// Обработчики событий
			sendButton.addEventListener('click', sendMessage);
			messageInput.addEventListener('keypress', function (e) {
				if (e.key === 'Enter') {
					sendMessage();
				}
			});

			// Начинаем подключение
			connectWebSocket();
		</script>
	</body>
</html>
